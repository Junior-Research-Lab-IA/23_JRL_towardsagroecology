---
title: "DataAnalysis_Ver2"
author: "Melissa"
date: "2023-06-12"
output: word_document
editor_options: 
  chunk_output_type: console
---
```{r package, include=FALSE}
library(readr)
library(agricolae)
library(ggplot2)
library(tidyverse)
library(cowplot)
library(GGally)
library(ggpattern)
library(leaps)
library(Hmisc)
library(corrplot)
library(lmtest)
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```



```{r Dataset, include=FALSE}
setwd("C:/Users/melis/OneDrive - Universiti Putra Malaysia/Documents/GitHub/23_JRL_towardsagroecology")


Data <- read_csv("SALSADataset.csv")%>%
  select(-Direction)%>%
  na.omit()

Data$Year_Stability=as.factor(Data$Year_Stability)
Data$Year_CN=as.factor(Data$Year_CN)
Data$Year_Bulk=as.factor(Data$Year_CN)

str(Data)

```

## Stability Anova Test in 2019 and 2023

In this anova test, we will test the effect of treatment,block&plot(location) and year on soil stability. 

```{r Stability, echo=FALSE}
Stb=Data%>% 
  select (Treatment,Block,Plot,Rep,Year_Stability,Stability)%>%
  arrange(Year_Stability, Treatment)%>%
  na.omit()

Str_Stb= aov(Stability~Treatment+Year_Stability+Treatment*Year_Stability+Block+Plot, data=Stb)
anova(Str_Stb)

#Based on Anova, the plot did not affect the soil stability. 

#LSD Year
Str_Stb_Year= LSD.test(Str_Stb,"Year_Stability")
Str_Stb_Year

SigLetter_Year = Str_Stb_Year$groups%>%
  group_by(rownames(Str_Stb_Year$groups)) %>%
  arrange(rownames(Str_Stb_Year$groups))

names(SigLetter_Year)[3] = "Year"

print(SigLetter_Year)

#LSD Treatment (Overall performance)
Str_Stb_Trt= LSD.test(Str_Stb,"Treatment")
SigLetter_Stb_Trt = Str_Stb_Trt$groups%>%
  group_by(rownames(Str_Stb_Trt$groups)) %>%
  arrange(groups)

names(SigLetter_Stb_Trt)[3] = "Treatment"
print(SigLetter_Stb_Trt)

#LSD Block (Overall performance)
Str_Stb_Block= LSD.test(Str_Stb,"Block")
SigLetter_Stb_Block = Str_Stb_Block$groups%>%
  group_by(rownames(Str_Stb_Block$groups)) %>%
  arrange(groups)

names(SigLetter_Stb_Block)[3] = "Block"
print(SigLetter_Stb_Block)

#LSD Interaction between Treatment and Year
LSD_Test_TrtStb= LSD.test(Str_Stb, c("Treatment", "Year_Stability"))
SigLetter_TrtStb = LSD_Test_TrtStb$groups  %>%
  group_by(rownames(LSD_Test_TrtStb$groups)) %>%
  arrange(rownames(LSD_Test_TrtStb$groups))
names(SigLetter_TrtStb)[3] = "Interaction between Treatment and Year"
print(SigLetter_TrtStb)

Valuemax_TrtStb=Stb%>%
  group_by(Treatment,Year_Stability)%>%
  summarise(max_value=max(Stability))
  


ggplot(Data, aes(x=Treatment, y=Stability,fill=Year_Stability))+ geom_boxplot()+geom_text(data=Valuemax_TrtStb, aes(x=Treatment, y=0.1+max_value, label=SigLetter_TrtStb$groups),position = position_dodge(width = 0.9),vjust = -(0.5))+ ggtitle("Soil Stability in 2019 and 2023: \n The interaction between treatment and year")+theme(plot.title = element_text(hjust = 0.5),legend.position="bottom")
```


## Bulk Density in 2020 and 2023

```{r bulkdensity, echo=FALSE}
Bulk=Data%>% 
  select (Treatment,Block,Plot,Rep,Year_Bulk,Bulk_Density, Depth)%>%
  arrange(Year_Bulk, Treatment)%>%
  na.omit()

Ano_Bulk= aov(Bulk_Density~Treatment+Year_Bulk+Depth+Block+Plot+Treatment*Depth*Year_Bulk, data=Bulk)
anova(Ano_Bulk)


Bulk_Year= LSD.test(Ano_Bulk,"Year_Bulk")
Bulk_Year


Bulk_Trt= LSD.test(Ano_Bulk,"Treatment")
Bulk_Trt
Bulk_Block= LSD.test(Ano_Bulk,"Block")
Bulk_Block
Bulk_Depth = LSD.test(Ano_Bulk,"Depth")
Bulk_Depth 


### Interaction between treatment & Year 
LSD_Test_TrtYear= LSD.test(Ano_Bulk, c("Treatment", "Year_Bulk"))

SigLetter_TrtYear = LSD_Test_TrtYear$groups  %>%
  group_by(rownames(LSD_Test_TrtYear$groups)) %>%
  arrange(groups)

names(SigLetter_TrtYear)[3] = "Interaction between Treatment and year"

SigLetter_TrtYear= SigLetter_TrtYear%>%
  select(`Interaction between Treatment and year`, Bulk_Density, groups)
print(SigLetter_TrtYear)


### Interaction between treatment and depth
LSD_Test_TrtDepth= LSD.test(Ano_Bulk, c("Treatment", "Depth"))

SigLetter_TrtDepth = LSD_Test_TrtDepth$groups  %>%
  group_by(rownames(LSD_Test_TrtDepth$groups)) %>%
  arrange(groups)

names(SigLetter_TrtDepth)[3] = "Interaction between Treatment and depth"

SigLetter_TrtDepth= SigLetter_TrtDepth%>%
  select(`Interaction between Treatment and depth`, Bulk_Density, groups)

print(SigLetter_TrtDepth)

###Interaction between depth and year

### Interaction between Treatment,depth and year
LSD_Test_DepthYear= LSD.test(Ano_Bulk, c( "Depth", "Year_Bulk"))

SigLetter_DepthYear = LSD_Test_DepthYear$groups  %>%
  group_by(rownames(LSD_Test_DepthYear$groups)) %>%
  arrange(groups)

names(SigLetter_DepthYear)[3] = "Interaction between depth and year"

SigLetter_DepthYear= SigLetter_DepthYear%>%
  select(`Interaction between depth and year`, Bulk_Density, groups)
print(SigLetter_DepthYear)

### Interaction between Treatment,depth and year
LSD_Test_TrtDepthYear= LSD.test(Ano_Bulk, c("Treatment", "Depth", "Year_Bulk"))

SigLetter_TrtDepthYear = LSD_Test_TrtDepthYear$groups  %>%
  group_by(rownames(LSD_Test_TrtDepthYear$groups)) %>%
  arrange(groups)

names(SigLetter_TrtDepthYear)[3] = "Interaction between Treatment,depth and year"

SigLetter_TrtDepthYear= SigLetter_TrtDepthYear%>%
  select(`Interaction between Treatment,depth and year`, Bulk_Density, groups)
print(SigLetter_TrtDepthYear)
```


```{r soilpropeties, echo=FALSE}
Stone_ratio= aov(`Stone:soil`~ Block, data=Data)
anova(Stone_ratio)
LSD_Stone_ratio= LSD.test(Stone_ratio, "Block")
LSD_Stone_ratio

SoilTX= aov(`DG_soilTx`~ Block, data=Data)
anova(SoilTX)
LSD_SoilTX= LSD.test(SoilTX, "Block")
LSD_SoilTX
```
Each block have different soil texture and stone:soil ratio. 



## Corelation Test

```{r correlation, eval=FALSE, include=FALSE}
X= Data %>% 
 select(10:24)

res2 <- rcorr(as.matrix(X))
#extarct r &p
correlatio_r = res2$r
correlation_p = res2$P

Corrlation_test1=flattenCorrMatrix(res2$r, res2$P)%>%
  filter(p<=0.05,cor<=-0.5)
Corrlation_test2=flattenCorrMatrix(res2$r, res2$P)%>%
  filter(p<=0.05,cor>=0.5)

#Select p<=0.05,cor>=0.5 or cor<=-0.5
Correlation=rbind(Corrlation_test1,Corrlation_test2)%>%
  select(-p)%>%
  arrange(cor)%>%
  mutate(`P-value<0.05`= "significant")

write.csv(Correlation,"C:/Users/melis/OneDrive - Universiti Putra Malaysia/Documents/GitHub/23_JRL_towardsagroecology/Correlation.csv",row.names=FALSE)
```

##Soil Stability Modelling. 

```{r StabilityModelling, echo=FALSE}

modelling=Data%>% 
  select(-Variety,-Year_CN)%>%
  na.omit()%>%
  group_by(Treatment,Block,Year_Stability,Depth)%>%
  summarise(Stability= mean(Stability),bulk=mean(Bulk_Density),TotalOM=mean(TotalOM),TotalN=mean(TotalN),CN= mean(CN),Cmin=mean(Cmin),`Cmin%`=mean(`Cmin%`), NH4=mean(NH4), NO3= mean(NO3), Nmin_Drysoil=mean(Nmin),`Nmin%`=mean(`Nmin%`), humidity=mean(Humidity), F_Mechanical=mean(`F_Mechanical actions`), soiltx=mean(DG_soilTx),`Stone:soil`=mean(`Stone:soil`) )        

            
modelling$Year_Stability=as.factor(modelling$Year_Stability)

Stb_1=lm(Stability~ Treatment+ TotalOM + Year_Stability +TotalN+CN+Cmin+`Cmin%`+NO3+NH4+Nmin_Drysoil+`Nmin%`+humidity+F_Mechanical+soiltx+`Stone:soil`, data=modelling)

AIC_Stb_1=step(Stb_1,direction="both")

Stb_2=lm(Stability ~ Treatment + TotalOM + Year_Stability + TotalN + CN + 
    Cmin + `Cmin%` + NO3 + NH4 + Nmin_Drysoil + `Nmin%` + humidity, data=modelling)
drop1(Stb_2,.~.,test="F")

summary(Stb_2)

```

**Soil Stability multiple linear model:**

*lm(formula = Stability ~ Treatment + TotalOM + Year_Stability + 
    TotalN + CN + Cmin + `Cmin%` + NO3 + NH4 + Nmin_Drysoil + 
    `Nmin%` + humidity, data = Stability_model)*

Adjusted R-squared:  **0.9466**


**Model Assumption Check**

```{r normality, echo=FALSE, message=FALSE, warning=FALSE}
modelling$res.Stb_2=Stb_2 $residuals 
shapiro.test(modelling$res.Stb_2)
```
*It is normal*

2. Homoscedasticity Test

```{r Homoscedasticity, echo=FALSE, message=FALSE, warning=FALSE}
bptest(Stb_2)
```
It is homoscedasticity. 


##Stability Modelling Test 2. 

```{r Bulk_density, echo=FALSE}

colnames(modelling)

Bulk_model=Data%>% 
  select(-Variety,-Year_CN,-Year_Stability)%>%
  na.omit()%>%
  group_by(Treatment,Block,Year_Bulk,Depth)%>%
  summarise(Stability= mean(Stability),bulk=mean(Bulk_Density),TotalOM=mean(TotalOM),TotalN=mean(TotalN),CN= mean(CN),Cmin=mean(Cmin),`Cmin%`=mean(`Cmin%`), NH4=mean(NH4), NO3= mean(NO3), Nmin_Drysoil=mean(Nmin),`Nmin%`=mean(`Nmin%`), humidity=mean(Humidity), F_Mechanical=mean(`F_Mechanical actions`), soiltx=mean(DG_soilTx),`Stone:soil`=mean(`Stone:soil`) )        

Bulk.1=lm(bulk~ Treatment+ TotalOM + Year_Bulk + Depth+ +TotalN+CN+Cmin+`Cmin%`+NO3+NH4+Nmin_Drysoil+`Nmin%`+humidity+F_Mechanical+soiltx+`Stone:soil`, data=Bulk_model)

AIC_Bulk.1=step(Bulk.1,direction="both")

Bulk.2=lm(bulk ~ `Nmin%` + humidity + soiltx, data=Bulk_model)
drop1(Bulk.2,.~.,test="F")

summary(Bulk.2)


Bulk_model$res.Bulk.2=Bulk.2 $residuals 
shapiro.test(Bulk_model$res.Bulk.2)

ggplot(Bulk_model, aes(sample = res.Bulk.2)) +
stat_qq() +
stat_qq_line()+
labs(title = "Normal Q-Q Plot of Stb_3.2")

bptest(Bulk.2)

```